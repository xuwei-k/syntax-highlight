<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>MyMailService.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> com.github.xuwei_k

<span class="keyword">import</span> java.io._
<span class="keyword">import</span> java.util.Properties;
<span class="keyword">import</span> javax.mail._
<span class="keyword">import</span> javax.mail.internet._
<span class="keyword">import</span> javax.mail.util._
<span class="keyword">import</span> javax.servlet.http._
<span class="keyword">import</span> javax.mail.<span class="delimiter">{</span>Session<span class="delimiter">}</span>
<span class="keyword">import</span> javax.mail.internet.MimeMessage
<span class="keyword">import</span> com.google.appengine.api.mail.<span class="delimiter">{</span>MailService,MailServiceFactory<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object com.github.xuwei_k.MyMailService" id="9223">MyMailService</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="comment">//添付ファイル</span>
  case <span class="keyword">class</span> <a title="class Attachment extends java.lang.Object with ScalaObject with Product" id="28612">Attachment</a><span title="ScalaObject" class="delimiter">(</span><a title="=&gt; String" id="28600">name</a>:<span title="String">String</span>,<a title="=&gt; java.io.InputStream" id="28601">data</a>:<span title="java.io.InputStream">InputStream</span><span class="delimiter">)</span>

  <span class="comment">/** メール送信
   *
   */</span>
  <span class="keyword">def</span> <a title="(sendAddress: String,attachments: com.google.appengine.api.mail.MailService.Attachment*)Unit" id="22702">send</a><span class="delimiter">(</span><a title="String" id="22705">sendAddress</a>:<span title="String">String</span>,<a title="com.google.appengine.api.mail.MailService.Attachment*" id="22706">attachments</a>:MailService.<span title="com.google.appengine.api.mail.MailService.Attachment*">Attachment</span> *<span class="delimiter">)</span><span class="delimiter">{</span>

    <span class="comment">//なにかしら、本文に文字を入れないと、送信できないらしい!!!</span>
    <span class="keyword">val</span> <a title="com.google.appengine.api.mail.MailService.Message" id="27734">message</a> = <span title="(x$1: java.lang.String,x$2: java.lang.String,x$3: java.lang.String,x$4: java.lang.String)com.google.appengine.api.mail.MailService.Message" class="keyword">new</span> <span title="object com.google.appengine.api.mail.MailService">MailService</span>.<span title="com.google.appengine.api.mail.MailService.Message">Message</span><span class="delimiter">(</span> <span title="java.lang.String(&quot;test1@xuwei-k.appspotmail.com&quot;)" class="string">&quot;test1@xuwei-k.appspotmail.com&quot;</span> , <a href="#22705" title="String">sendAddress</a> ,<span title="java.lang.String(&quot;test&quot;)" class="string">&quot;test&quot;</span> , <span title="java.lang.String(&quot;body&quot;)" class="string">&quot;body&quot;</span> <span class="delimiter">)</span>
      <a href="#27734" title="com.google.appengine.api.mail.MailService.Message">message</a>.<span title="(x$1: &lt;repeated...&gt;[com.google.appengine.api.mail.MailService.Attachment])Unit">setAttachments</span><span class="delimiter">(</span><a href="#22706" title="com.google.appengine.api.mail.MailService.Attachment*">attachments</a>:_*<span class="delimiter">)</span>
      <span title="object com.google.appengine.api.mail.MailServiceFactory">MailServiceFactory</span>.<span title="()com.google.appengine.api.mail.MailService">getMailService</span>.<span title="(x$1: com.google.appengine.api.mail.MailService.Message)Unit">send</span><span class="delimiter">(</span><a href="#27734" title="com.google.appengine.api.mail.MailService.Message">message</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * メール解析
   */</span>
  <span class="keyword">def</span> <a title="(part: javax.mail.Part,list: List[com.github.xuwei_k.MyMailService.Attachment])List[com.github.xuwei_k.MyMailService.Attachment]" id="22703">partAnalysis</a><span class="delimiter">(</span><a title="javax.mail.Part" id="25311">part</a>:<span title="javax.mail.Part">Part</span>,<a title="List[com.github.xuwei_k.MyMailService.Attachment]" id="25312">list</a>:<span title="List[com.github.xuwei_k.MyMailService.Attachment]">List</span><span class="delimiter">[</span>Attachment<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="List[com.github.xuwei_k.MyMailService.Attachment]">List</span><span class="delimiter">[</span>Attachment<span class="delimiter">]</span>= <span class="delimiter">{</span>

    <span title="List[com.github.xuwei_k.MyMailService.Attachment]" class="keyword">if</span> <span class="delimiter">(</span><a href="#25311" title="javax.mail.Part">part</a>.<span title="(x$1: java.lang.String)Boolean">isMimeType</span><span class="delimiter">(</span><span title="java.lang.String(&quot;multipart/*&quot;)" class="string">&quot;multipart/*&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>

      <span class="keyword">val</span> <a title="javax.mail.Multipart" id="27816">content</a> = <a href="#25311" title="javax.mail.Part">part</a>.<span title="()java.lang.Object">getContent</span>.<span title="[T0]T0">asInstanceOf</span><span title="javax.mail.Multipart" class="delimiter">[</span><span title="javax.mail.Multipart">Multipart</span><span class="delimiter">]</span>

      <span class="comment">// 含まれるパートを再帰的に処理</span>
      <a href="#25312" title="(that: scala.collection.TraversableOnce[com.github.xuwei_k.MyMailService.Attachment])(implicit bf: scala.collection.generic.CanBuildFrom[List[com.github.xuwei_k.MyMailService.Attachment],com.github.xuwei_k.MyMailService.Attachment,List[com.github.xuwei_k.MyMailService.Attachment]])List[com.github.xuwei_k.MyMailService.Attachment]">list</a> <span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,com.github.xuwei_k.MyMailService.Attachment,List[com.github.xuwei_k.MyMailService.Attachment]]">++</span> <span class="delimiter">{</span>
        <span class="delimiter">(</span><span title="(end: Int)scala.collection.immutable.Range with scala.collection.immutable.Range.ByOne" class="int">0</span> until <a href="#27816" title="javax.mail.Multipart">content</a>.<span title="()Int">getCount</span><span class="delimiter">)</span>.<span title="(f: (Int) =&gt; List[com.github.xuwei_k.MyMailService.Attachment])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],List[com.github.xuwei_k.MyMailService.Attachment],scala.collection.immutable.IndexedSeq[List[com.github.xuwei_k.MyMailService.Attachment]]])scala.collection.immutable.IndexedSeq[List[com.github.xuwei_k.MyMailService.Attachment]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,List[com.github.xuwei_k.MyMailService.Attachment],scala.collection.immutable.IndexedSeq[List[com.github.xuwei_k.MyMailService.Attachment]]]" class="delimiter">{</span>
          <a title="Int" id="28202">n</a> =&gt; <a href="#22703" title="(part: javax.mail.Part,list: List[com.github.xuwei_k.MyMailService.Attachment])List[com.github.xuwei_k.MyMailService.Attachment]">partAnalysis</a><span class="delimiter">(</span><a href="#27816" title="javax.mail.Multipart">content</a>.<span title="(x$1: Int)javax.mail.BodyPart">getBodyPart</span><span class="delimiter">(</span><a href="#28202" title="Int">n</a><span class="delimiter">)</span>,<span title="object Nil">Nil</span><span class="delimiter">)</span> 
        <span class="delimiter">}</span>.<span title="(implicit asTraversable: (List[com.github.xuwei_k.MyMailService.Attachment]) =&gt; Traversable[com.github.xuwei_k.MyMailService.Attachment])scala.collection.immutable.IndexedSeq[com.github.xuwei_k.MyMailService.Attachment]">flatten</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="List[com.github.xuwei_k.MyMailService.Attachment]" class="keyword">if</span> <span class="delimiter">(</span><a href="#25311" title="javax.mail.Part">part</a>.<span title="(x$1: java.lang.String)Boolean">isMimeType</span><span class="delimiter">(</span><span title="java.lang.String(&quot;text/plain&quot;)" class="string">&quot;text/plain&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// テキストの場合なにもしない</span>
      <a href="#25312" title="List[com.github.xuwei_k.MyMailService.Attachment]">list</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// その他の場合</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="28532">disp</a> = <a href="#25311" title="javax.mail.Part">part</a>.<span title="()java.lang.String">getDisposition</span>

      <span title="List[com.github.xuwei_k.MyMailService.Attachment]" class="keyword">if</span> <span class="delimiter">(</span><a href="#28532" title="(x$1: AnyRef)Boolean">disp</a> <span title="(x$1: Boolean)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> || <a href="#28532" title="java.lang.String">disp</a>.<span title="(x$1: java.lang.String)Boolean">equalsIgnoreCase</span><span class="delimiter">(</span>Part.<span title="java.lang.String(&quot;attachment&quot;)">ATTACHMENT</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#22704" title="(part: javax.mail.Part)com.github.xuwei_k.MyMailService.Attachment">getAttachments</a><span class="delimiter">(</span><a href="#25311" title="javax.mail.Part">part</a><span class="delimiter">)</span> <a href="#28541" title="com.github.xuwei_k.MyMailService.Attachment">::</a> <a href="#25312" title="(x: com.github.xuwei_k.MyMailService.Attachment)List[com.github.xuwei_k.MyMailService.Attachment]">list</a>
      <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
        <a href="#25312" title="List[com.github.xuwei_k.MyMailService.Attachment]">list</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** 添付ファイル取得
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(part: javax.mail.Part)com.github.xuwei_k.MyMailService.Attachment" id="22704">getAttachments</a><span class="delimiter">(</span><a title="javax.mail.Part" id="28542">part</a>:<span title="javax.mail.Part">Part</span><span class="delimiter">)</span>:<a href="#28612" title="com.github.xuwei_k.MyMailService.Attachment">Attachment</a> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="java.lang.String" id="28551">name</a> = <span title="object javax.mail.internet.MimeUtility">MimeUtility</span>.<span title="(x$1: java.lang.String)java.lang.String">decodeText</span><span class="delimiter">(</span><a href="#28542" title="javax.mail.Part">part</a>.<span title="()java.lang.String">getFileName</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#28612" title="(name: String,data: java.io.InputStream)com.github.xuwei_k.MyMailService.Attachment">Attachment</a><span class="delimiter">(</span> <a href="#28551" title="java.lang.String">name</a> , <a href="#28542" title="javax.mail.Part">part</a>.<span title="()java.io.InputStream">getInputStream</span> <span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>